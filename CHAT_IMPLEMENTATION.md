# Chat Implementation

## Описание

Реализован простой протокол чата в формате: `CHAT_MESSAGE|playerName|text`

## Изменения

### Серверная часть

1. **SimpleChatHandler.kt** (новый файл)
   - Парсит простые текстовые сообщения формата `CHAT_MESSAGE|playerName|text`
   - Получает информацию о пользователе и комнате
   - Отправляет сообщение всем игрокам в комнате через broadcast

2. **MessageRouter.kt**
   - Добавлена проверка входящих сообщений на префикс `CHAT_MESSAGE|`
   - Если сообщение начинается с этого префикса, оно обрабатывается SimpleChatHandler
   - Иначе обрабатывается как обычное JSON сообщение

3. **Room.kt** (исправлена ошибка)
   - Исправлен метод `addPlayer()` - заменён `require` на `if`
   - Теперь игроки корректно добавляются в комнату

### Клиентская часть

1. **NetworkClient.kt**
   - Добавлен метод `sendTextMessage(text: String)` для отправки простых текстовых сообщений
   - Добавлен `textMessageListener` для обработки входящих текстовых сообщений
   - В `startReceiverThread()` добавлена проверка на `CHAT_MESSAGE|` префикс

2. **GameController.kt**
   - Обновлён метод `sendChat()` - теперь отправляет в формате `CHAT_MESSAGE|playerName|text`
   - Добавлен метод `handleTextMessage()` для парсинга входящих чат-сообщений
   - Создаёт ChatMessage объекты из текстовых сообщений и добавляет в chatModel

3. **MainApp.java**
   - Без изменений - уже корректно отображает чат через `updateChat()`

## Протокол

### Формат сообщения

```
CHAT_MESSAGE|playerName|text
```

Где:
- `CHAT_MESSAGE` - константа, идентификатор типа сообщения
- `playerName` - имя игрока, отправившего сообщение
- `text` - текст сообщения

### Примеры

Отправка:
```
CHAT_MESSAGE|Player1|Привет всем!
```

Получение (broadcast всем в комнате):
```
CHAT_MESSAGE|Player1|Привет всем!
```

## Тестирование

### Автоматический тест

Файл: `ChatTest.kt`

Запуск:
```bash
./run_chat_test.sh
```

Тест создаёт двух клиентов, подключает к серверу, создаёт комнату, присоединяет второго игрока и обменивается чат-сообщениями.

### Результаты теста

✅ Сервер получает сообщения: `Chat from Client1: Привет от Client 1!`
✅ Сервер рассылает сообщения: `Broadcast chat to 2 players in room 1`
✅ Клиенты получают все сообщения друг от друга
✅ UI корректно отображает чат-сообщения

## Преимущества реализации

1. **Простота** - максимально простой протокол без JSON парсинга для чата
2. **Совместимость** - работает параллельно с существующим JSON протоколом
3. **Эффективность** - меньше overhead по сравнению с JSON
4. **Kotlin** - вся новая функциональность написана на Kotlin

## Использование в UI

В JavaFX клиенте (MainApp.java) чат уже настроен:

1. Пользователь вводит текст в `chatInput`
2. При нажатии Enter или кнопки Send вызывается `sendChat()`
3. `GameController.sendChat()` отправляет `CHAT_MESSAGE|playerName|text`
4. Сервер получает, парсит и рассылает всем в комнате
5. Клиенты получают сообщение в `handleTextMessage()`
6. `updateChat()` обновляет `chatArea` с новыми сообщениями
